
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=0">
    <meta name="theme-color" content="#4f46e5">
    <meta name="description" content="لعبة تعليمية تفاعلية للأطفال لتعلم الحروف العربية">
    <title>مغامرة الحروف - Adventure of Letters</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Baloo+Bhaijaan+2:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
      body {
        font-family: 'Baloo Bhaijaan 2', sans-serif;
        overflow: hidden;
        touch-action: none;
        user-select: none;
        -webkit-user-select: none;
        background-color: #f0f9ff;
        margin: 0;
        padding: 0;
      }
      
      /* --- LOADING SPINNER --- */
      #loading-screen {
        position: fixed;
        inset: 0;
        background: #eef2ff;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        transition: opacity 0.5s ease-out;
      }
      .spinner {
        width: 50px;
        height: 50px;
        border: 5px solid #c7d2fe;
        border-top-color: #4f46e5;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }
      @keyframes spin { to { transform: rotate(360deg); } }

      /* --- ANIMATIONS --- */
      @keyframes swim-right-to-left {
        0% { transform: translate(0, 0) scaleX(-1); }
        25% { transform: translate(-40vw, -40px) rotate(5deg) scaleX(-1); }
        50% { transform: translate(-80vw, 0) rotate(0deg) scaleX(-1); }
        75% { transform: translate(-120vw, 40px) rotate(-5deg) scaleX(-1); }
        100% { transform: translate(-160vw, 0) rotate(0deg) scaleX(-1); }
      }

      @keyframes grow-in {
        0% { transform: scale(0); opacity: 0; }
        60% { transform: scale(1.1); }
        100% { transform: scale(1); opacity: 1; }
      }

      @keyframes float-up-high {
        0% { transform: translateY(10vh) translateX(0); opacity: 0; }
        10% { opacity: 1; }
        25% { transform: translateY(-30vh) translateX(15px); }
        50% { transform: translateY(-60vh) translateX(-15px); }
        75% { transform: translateY(-90vh) translateX(15px); }
        100% { transform: translateY(-120vh) translateX(0); opacity: 1; }
      }

      @keyframes pop-effect {
        0% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.4); opacity: 0.8; }
        100% { transform: scale(2); opacity: 0; }
      }
      
      @keyframes particle-fade {
        0% { transform: translate(0, 0) scale(1); opacity: 1; }
        100% { transform: translate(var(--tx), var(--ty)) scale(0); opacity: 0; }
      }

      @keyframes pop-in-bounce {
        0% { transform: scale(0); opacity: 0; }
        60% { transform: scale(1.2); opacity: 1; }
        80% { transform: scale(0.9); }
        100% { transform: scale(1); }
      }
      
      @keyframes fade-out-up {
        0% { transform: translateY(0); opacity: 1; }
        100% { transform: translateY(-50px); opacity: 0; }
      }
      
      @keyframes float-out-up {
        0% { transform: translateY(0); opacity: 1; }
        100% { transform: translateY(-100px); opacity: 0; }
      }

      .animate-swim-rl { animation-name: swim-right-to-left; animation-timing-function: linear; animation-fill-mode: forwards; }
      .animate-grow { animation-name: grow-in; animation-duration: 0.5s; animation-timing-function: ease-out; animation-fill-mode: forwards; }
      .animate-float { animation-name: float-up-high; animation-timing-function: linear; animation-fill-mode: forwards; }
      .animate-pop { animation-name: pop-effect; animation-duration: 0.3s; animation-timing-function: ease-out; animation-fill-mode: forwards; }
      .animate-entrance { animation: pop-in-bounce 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
      .animate-wrong { animation: fade-out-up 0.8s ease-out forwards; }
      .animate-float-out { animation: float-out-up 1.5s ease-out forwards; }

      .animate-bounce-slow { animation: bounce 2s infinite; }
      @keyframes bounce {
        0%, 100% { transform: translateY(-5%); }
        50% { transform: translateY(0); }
      }

      .shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
      @keyframes shake {
        10%, 90% { transform: translate3d(-1px, 0, 0); }
        20%, 80% { transform: translate3d(2px, 0, 0); }
        30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
        40%, 60% { transform: translate3d(4px, 0, 0); }
      }
      
      .cursor-crosshair { cursor: crosshair; }
      
      .particle {
        position: absolute;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        pointer-events: none;
        animation: particle-fade 0.8s ease-out forwards;
      }
    </style>
<script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "lucide-react": "https://aistudiocdn.com/lucide-react@^0.555.0"
  }
}
</script>
</head>
<body>
    <!-- LOADING SCREEN (Visible until React mounts) -->
    <div id="loading-screen">
        <div class="spinner"></div>
        <h2 style="margin-top: 20px; color: #4338ca; font-weight: bold; font-size: 1.5rem;">جاري التحميل...</h2>
    </div>

    <div id="root"></div>

    <script type="text/babel" data-presets="typescript,react">
        const { useState, useEffect, useRef, useCallback } = React;

        // --- 1. ICONS (Inline SVG - No Imports) ---
        const Fish = ({className, ...props}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}><path d="M6.5 12c.94-3.46 4.94-6 8.5-6 3.56 0 6.06 2.54 7 6-3.46 4.94-6 8.5-6 8.5-3.56 0-6.06-2.54-7-6z"/><path d="M18 12v.5"/><path d="M16 17.93a9.77 9.77 0 0 1 0-11.86"/><path d="M7 10.67C7 8 5.58 5.97 2.73 5.5c-1 1.5-1 5 .23 6.5-1.24 1.5-1.24 5-.23 6.5C5.58 18.03 7 16 7 13.33"/><path d="M10.46 7.26C10.2 5.88 9.17 4.24 8 3h5.8a2 2 0 0 1 1.98 1.67l.23 1.4"/></svg>;
        const Apple = ({className, ...props}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}><path d="M12 20.94c1.5 0 2.75 1.06 4 1.06 3 0 6-8 6-12.22A4.91 4.91 0 0 0 17 5c-2.22 0-4 1.44-5 2-1-.56-2.78-2-5-2a4.9 4.9 0 0 0-5 4.78C2 14 5 22 8 22c1.25 0 2.5-1.06 4-1.06Z"/><path d="M10 2c1 .5 2 2 2 5"/></svg>;
        const Cloud = ({className, ...props}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}><path d="M17.5 19c0-3.037-2.463-5.5-5.5-5.5S6.5 15.963 6.5 19"/><path d="M13 22H6.5c-3.5 0-6.5-3-6.5-6.5S2.5 9 6 9c.325 0 .644.025.955.073C7.632 5.378 11.233 3 15.5 3c4.694 0 8.5 3.806 8.5 8.5 0 1.516-.405 2.932-1.11 4.168"/></svg>;
        const Play = ({className, ...props}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}><polygon points="6 3 20 12 6 21 6 3"/></svg>;
        const Pause = ({className, ...props}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}><rect width="4" height="16" x="6" y="4"/><rect width="4" height="16" x="14" y="4"/></svg>;
        const LogOut = ({className, ...props}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>;
        const Heart = ({className, ...props}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg>;
        const Volume2 = ({className, ...props}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/></svg>;
        const VolumeX = ({className, ...props}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><line x1="23" x2="17" y1="9" y2="15"/><line x1="17" x2="23" y1="9" y2="15"/></svg>;
        const Star = ({className, ...props}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>;
        const LayoutGrid = ({className, ...props}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}><rect width="7" height="7" x="3" y="3" rx="1"/><rect width="7" height="7" x="14" y="3" rx="1"/><rect width="7" height="7" x="14" y="14" rx="1"/><rect width="7" height="7" x="3" y="14" rx="1"/></svg>;
        const Trophy = ({className, ...props}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>;
        const RotateCcw = ({className, ...props}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>;
        const XCircle = ({className, ...props}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></svg>;
        const Hand = ({className, ...props}) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}><path d="M18 11V6a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v0"/><path d="M14 10V4a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v2"/><path d="M10 10.5V6a2 2 0 0 0-2-2v0a2 2 0 0 0-2 2v8"/><path d="M18 8a2 2 0 1 1 4 0v6a8 8 0 0 1-8 8h-2c-2.8 0-4.5-.86-5.99-2.34l-3.6-3.6a2 2 0 0 1 2.83-2.82L7 15"/></svg>;

        // Custom Basket SVG
        const CustomBasketIcon = ({ size, className }) => (
          <svg width={size} height={size} viewBox="0 0 100 100" className={className} fill="none" xmlns="http://www.w3.org/2000/svg">
            <ellipse cx="50" cy="35" rx="40" ry="10" fill="#5D4037" />
            <path d="M10 35 L20 85 Q50 95 80 85 L90 35 Z" fill="#795548" stroke="#3E2723" strokeWidth="2" />
            <ellipse cx="50" cy="35" rx="40" ry="10" fill="#8D6E63" stroke="#3E2723" strokeWidth="2" />
            <path d="M20 50 Q50 60 80 50" stroke="#3E2723" strokeWidth="1" strokeOpacity="0.5" fill="none"/>
            <path d="M25 65 Q50 75 75 65" stroke="#3E2723" strokeWidth="1" strokeOpacity="0.5" fill="none"/>
            <path d="M30 40 L35 80" stroke="#3E2723" strokeWidth="1" strokeOpacity="0.5" fill="none"/>
            <path d="M50 40 L50 85" stroke="#3E2723" strokeWidth="1" strokeOpacity="0.5" fill="none"/>
            <path d="M70 40 L65 80" stroke="#3E2723" strokeWidth="1" strokeOpacity="0.5" fill="none"/>
            <rect x="35" y="55" width="30" height="15" rx="4" fill="#FFF8E1" stroke="#3E2723" strokeWidth="1" />
          </svg>
        );

        // --- 2. DATA (With Audio URLs) ---
        const ARABIC_LETTERS_DATA = [
          { id: 'أ', isolated: 'أ', initial: 'أ', medial: 'ـأ', final: 'ـأ', audioUrl: 'https://ia601902.us.archive.org/4/items/elifba_tektek_harfler/01_elif.mp3' },
          { id: 'ب', isolated: 'ب', initial: 'بـ', medial: 'ـبـ', final: 'ـب', audioUrl: 'https://ia601902.us.archive.org/4/items/elifba_tektek_harfler/02_ba.mp3' },
          { id: 'ت', isolated: 'ت', initial: 'تـ', medial: 'ـتـ', final: 'ـت', audioUrl: 'https://ia601902.us.archive.org/4/items/elifba_tektek_harfler/03_ta.mp3' },
          { id: 'ث', isolated: 'ث', initial: 'ثـ', medial: 'ـثـ', final: 'ـث', audioUrl: 'https://ia601902.us.archive.org/4/items/elifba_tektek_harfler/04_se.mp3' },
          { id: 'ج', isolated: 'ج', initial: 'جـ', medial: 'ـجـ', final: 'ـج', audioUrl: 'https://ia601902.us.archive.org/4/items/elifba_tektek_harfler/05_cim.mp3' },
          { id: 'ح', isolated: 'ح', initial: 'حـ', medial: 'ـحـ', final: 'ـح', audioUrl: 'https://ia601902.us.archive.org/4/items/elifba_tektek_harfler/06_ha.mp3' },
          { id: 'خ', isolated: 'خ', initial: 'خـ', medial: 'ـخـ', final: 'ـخ', audioUrl: 'https://ia601902.us.archive.org/4/items/elifba_tektek_harfler/07_hi.mp3' },
          { id: 'د', isolated: 'د', initial: 'د', medial: 'ـد', final: 'ـد', audioUrl: 'https://ia601902.us.archive.org/4/items/elifba_tektek_harfler/08_dal.mp3' },
          { id: 'ذ', isolated: 'ذ', initial: 'ذ', medial: 'ـذ', final: 'ـذ', audioUrl: 'https://ia601902.us.archive.org/4/items/elifba_tektek_harfler/09_zal.mp3' },
          { id: 'ر', isolated: 'ر', initial: 'ر', medial: 'ـر', final: 'ـر', audioUrl: 'https://ia601902.us.archive.org/4/items/elifba_tektek_harfler/10_ra.mp3' },
          { id: 'ز', isolated: 'ز', initial: 'ز', medial: 'ـز', final: 'ـز', audioUrl: 'https://ia601902.us.archive.org/4/items/elifba_tektek_harfler/11_ze.mp3' },
          { id: 'س', isolated: 'س', initial: 'سـ', medial: 'ـسـ', final: 'ـس', audioUrl: 'https://ia601902.us.archive.org/4/items/elifba_tektek_harfler/12_sin.mp3' },
          { id: 'ش', isolated: 'ش', initial: 'شـ', medial: 'ـشـ', final: 'ـش', audioUrl: 'https://ia601902.us.archive.org/4/items/elifba_tektek_harfler/13_shin.mp3' },
          { id: 'ص', isolated: 'ص', initial: 'صـ', medial: 'ـصـ', final: 'ـص', audioUrl: 'https://ia601902.us.archive.org/4/items/elifba_tektek_harfler/14_sad.mp3' },
          { id: 'ض', isolated: 'ض', initial: 'ضـ', medial: 'ـضـ', final: 'ـض', audioUrl: 'https://ia601902.us.archive.org/4/items/elifba_tektek_harfler/15_dad.mp3' },
          { id: 'ط', isolated: 'ط', initial: 'طـ', medial: 'ـطـ', final: 'ـط', audioUrl: 'https://ia601902.us.archive.org/4/items/elifba_tektek_harfler/16_ta.mp3' },
          { id: 'ظ', isolated: 'ظ', initial: 'ظـ', medial: 'ـظـ', final: 'ـظ', audioUrl: 'https://ia601902.us.archive.org/4/items/elifba_tektek_harfler/17_za.mp3' },
          { id: 'ع', isolated: 'ع', initial: 'عـ', medial: 'ـعـ', final: 'ـع', audioUrl: 'https://ia601902.us.archive.org/4/items/elifba_tektek_harfler/18_ayn.mp3' },
          { id: 'غ', isolated: 'غ', initial: 'غـ', medial: 'ـغـ', final: 'ـغ', audioUrl: 'https://ia601902.us.archive.org/4/items/elifba_tektek_harfler/19_gayn.mp3' },
          { id: 'ف', isolated: 'ف', initial: 'فـ', medial: 'ـفـ', final: 'ـف', audioUrl: 'https://ia601902.us.archive.org/4/items/elifba_tektek_harfler/20_fe.mp3' },
          { id: 'ق', isolated: 'ق', initial: 'قـ', medial: 'ـقـ', final: 'ـق', audioUrl: 'https://ia601902.us.archive.org/4/items/elifba_tektek_harfler/21_gaf.mp3' },
          { id: 'ك', isolated: 'ك', initial: 'كـ', medial: 'ـكـ', final: 'ـك', audioUrl: 'https://ia601902.us.archive.org/4/items/elifba_tektek_harfler/22_kef.mp3' },
          { id: 'ل', isolated: 'ل', initial: 'لـ', medial: 'ـلـ', final: 'ـل', audioUrl: 'https://ia601902.us.archive.org/4/items/elifba_tektek_harfler/23_lam.mp3' },
          { id: 'م', isolated: 'م', initial: 'مـ', medial: 'ـمـ', final: 'ـم', audioUrl: 'https://ia601902.us.archive.org/4/items/elifba_tektek_harfler/24_mim.mp3' },
          { id: 'ن', isolated: 'ن', initial: 'نـ', medial: 'ـنـ', final: 'ـن', audioUrl: 'https://ia601902.us.archive.org/4/items/elifba_tektek_harfler/25_nun.mp3' },
          { id: 'ه', isolated: 'هـ', initial: 'هـ', medial: 'ـهـ', final: 'ـه', audioUrl: 'https://ia601902.us.archive.org/4/items/elifba_tektek_harfler/26_he.mp3' },
          { id: 'و', isolated: 'و', initial: 'و', medial: 'ـو', final: 'ـو', audioUrl: 'https://ia601902.us.archive.org/4/items/elifba_tektek_harfler/27_vav.mp3' },
          { id: 'ي', isolated: 'ي', initial: 'يـ', medial: 'ـيـ', final: 'ـي', audioUrl: 'https://ia601902.us.archive.org/4/items/elifba_tektek_harfler/28_ya.mp3' },
        ];

        // --- 3. AUDIO MANAGER ---
        class AudioManager {
          constructor() {
            this.bgm = null;
            this.muted = false;
            this.audioCtx = null;
            this.sounds = {
                bgm_sea: 'assets/audio/ambience_underwater.mp3',
                bgm_forest: 'assets/audio/ambience_forest_birds.mp3',
                bgm_sky: 'assets/audio/ambience_wind.mp3',
            };
            const AudioContextClass = (window.AudioContext || window.webkitAudioContext);
            if (AudioContextClass) {
              this.audioCtx = new AudioContext();
            }
          }

          ensureAudioContext() {
            if (this.audioCtx && this.audioCtx.state === 'suspended') {
              this.audioCtx.resume();
            }
            if (!this.audioCtx) {
              const AudioContextClass = (window.AudioContext || window.webkitAudioContext);
              if (AudioContextClass) {
                this.audioCtx = new AudioContext();
              }
            }
          }

          setMute(isMuted) {
            this.muted = isMuted;
            if (this.bgm) {
              this.bgm.muted = isMuted;
            }
          }

          playTone(freq, type, duration, startTime = 0) {
            if (this.muted || !this.audioCtx) return;
            this.ensureAudioContext();

            const osc = this.audioCtx.createOscillator();
            const gain = this.audioCtx.createGain();

            osc.type = type;
            osc.frequency.setValueAtTime(freq, this.audioCtx.currentTime + startTime);
            gain.gain.setValueAtTime(0.1, this.audioCtx.currentTime + startTime);
            gain.gain.exponentialRampToValueAtTime(0.001, this.audioCtx.currentTime + startTime + duration);

            osc.connect(gain);
            gain.connect(this.audioCtx.destination);
            osc.start(this.audioCtx.currentTime + startTime);
            osc.stop(this.audioCtx.currentTime + startTime + duration);
          }

          playUISFX(type) {
            if (this.muted) return;
            if (type === 'hover') this.playTone(400, 'sine', 0.05);
            if (type === 'click') this.playTone(600, 'triangle', 0.1);
          }

          playSFX(key) {
            if (this.muted) return;
            switch (key) {
              case 'correct':
                this.playTone(880, 'sine', 0.5); 
                setTimeout(() => this.playTone(1100, 'sine', 0.4), 100);
                break;
              case 'wrong':
                this.playTone(150, 'sawtooth', 0.4);
                break;
              case 'gameover':
                this.playTone(400, 'triangle', 0.3);
                setTimeout(() => this.playTone(300, 'triangle', 0.3), 250);
                setTimeout(() => this.playTone(200, 'triangle', 0.8), 500);
                break;
              case 'win':
                this.playTone(523.25, 'sine', 0.2);
                setTimeout(() => this.playTone(659.25, 'sine', 0.2), 150);
                setTimeout(() => this.playTone(783.99, 'sine', 0.4), 300);
                break;
            }
          }

          playThemeSFX(type, themeId) {
            this.playSFX(type);
          }

          playLetterSound(url) {
            if (this.muted || !url) return;
            const audio = new Audio(url);
            audio.volume = 1.0; 
            audio.play().catch(e => { });
          }

          playBGM(theme) {
            if (this.muted) return;
            this.stopBGM();
            this.ensureAudioContext();
            const key = `bgm_${theme}`;
            const src = this.sounds[key];
            if (src) {
              this.bgm = new Audio(src);
              this.bgm.loop = true;
              this.bgm.volume = 0.1;
              this.bgm.muted = this.muted;
              this.bgm.play().catch(() => {});
            }
          }

          stopBGM() {
            if (this.bgm) {
              this.bgm.pause();
              this.bgm.currentTime = 0;
              this.bgm = null;
            }
          }
        }
        const audioManager = new AudioManager();

        // --- PARTICLE SYSTEM ---
        const Particle = ({ x, y, color }) => {
            const tx = (Math.random() - 0.5) * 100 + 'px';
            const ty = (Math.random() - 0.5) * 100 + 'px';
            return (
                <div 
                    className="particle" 
                    style={{ 
                        left: x, 
                        top: y, 
                        backgroundColor: color,
                        '--tx': tx, 
                        '--ty': ty 
                    }} 
                />
            );
        };

        // --- WRONG FEEDBACK SYSTEM ---
        const WrongMark = ({ x, y }) => (
            <div 
                className="absolute animate-wrong z-[60] pointer-events-none text-red-600 drop-shadow-lg"
                style={{ left: x - 12, top: y - 12 }}
            >
                <XCircle size={40} strokeWidth={3} />
            </div>
        );

        const FloatingText = ({ x, y, text }) => (
            <div 
                className="absolute animate-float-out z-[60] pointer-events-none text-red-500 font-black text-2xl drop-shadow-md"
                style={{ left: x, top: y, fontFamily: 'Baloo Bhaijaan 2' }}
            >
                {text}
            </div>
        );

        // --- 4. GAME OBJECT COMPONENT ---
        const GameObject = ({ entity, theme, onClick, onAnimationEnd, onDrop }) => {
          const [clicked, setClicked] = useState(false);
          const [interacted, setInteracted] = useState(false);
          const [isPopping, setIsPopping] = useState(false);
          
          const [position, setPosition] = useState({ x: 0, y: 0 });
          const [isDragging, setIsDragging] = useState(false);
          const dragStartRef = useRef({ x: 0, y: 0 });
          const elementRef = useRef(null);

          let animationClass = '';
          let style = {
            animationDuration: `${entity.duration}s`,
            animationDelay: '0s',
            touchAction: 'none'
          };

          if (isPopping) {
            animationClass = 'animate-pop';
          } else if (theme.id === 'sea') {
            animationClass = 'animate-swim-rl';
            style.top = `${entity.lane ? entity.lane * 14 : 50}%`; 
            style.left = '100vw'; 
          } else if (theme.id === 'forest') {
            animationClass = 'animate-grow';
            style.left = `${entity.startX}%`;
            style.top = `${entity.startY}%`;
            
            if (isDragging || (position.x !== 0 || position.y !== 0)) {
               style.transform = `translate(${position.x}px, ${position.y}px)`;
               animationClass = ''; 
               style.zIndex = 100; 
            } else {
               style.zIndex = 30; 
               style.transform = `rotate(${Math.random() * 20 - 10}deg)`;
            }
          } else {
            animationClass = 'animate-float';
            style.left = `${entity.startX}%`;
            style.bottom = '-15%'; 
          }

          const handleClick = (e) => {
            if (theme.id === 'forest') return; 
            e.stopPropagation();
            if (interacted) return;
            setInteracted(true);
            setClicked(true);

            // Pass event coordinates for particles
            const rect = e.currentTarget.getBoundingClientRect();
            const x = e.clientX || rect.left + rect.width / 2;
            const y = e.clientY || rect.top + rect.height / 2;

            if (theme.id === 'sky') {
                setIsPopping(true);
                setTimeout(() => {
                    onClick(entity.id, entity.isTarget, entity.letter, x, y);
                }, 100);
            } else {
                onClick(entity.id, entity.isTarget, entity.letter, x, y);
            }
          };

          const handleDragStart = (clientX, clientY) => {
            if (theme.id !== 'forest') return;
            setIsDragging(true);
            dragStartRef.current = { x: clientX - position.x, y: clientY - position.y };
          };

          const handleDragMove = (clientX, clientY) => {
            if (!isDragging) return;
            setPosition({
              x: clientX - dragStartRef.current.x,
              y: clientY - dragStartRef.current.y
            });
          };

          const handleDragEnd = () => {
            if (!isDragging) return;
            setIsDragging(false);
            
            if (elementRef.current && onDrop) {
                const rect = elementRef.current.getBoundingClientRect();
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + rect.height / 2;
                onDrop(entity.id, centerX, centerY);
            }
            
            setTimeout(() => {
                 if (!clicked) setPosition({ x: 0, y: 0 });
            }, 100);
          };

          useEffect(() => {
            if (isDragging) {
                const handleGlobalMove = (e) => handleDragMove(e.clientX, e.clientY);
                const handleGlobalUp = () => handleDragEnd();
                window.addEventListener('mousemove', handleGlobalMove);
                window.addEventListener('mouseup', handleGlobalUp);
                return () => {
                    window.removeEventListener('mousemove', handleGlobalMove);
                    window.removeEventListener('mouseup', handleGlobalUp);
                };
            }
          });

          const renderIcon = () => {
            const fishSize = "w-44 h-44 md:w-52 md:h-52 transition-transform"; 
            const standardSize = "w-16 h-16 md:w-20 md:h-20 transition-transform";

            switch (theme.objectIcon) {
              case 'fish':
                const colorClass = entity.color || 'text-orange-400 fill-orange-200';
                return <Fish className={`${fishSize} ${colorClass} drop-shadow-lg`} strokeWidth={1.5} />;
              case 'apple':
                return <Apple className={`${standardSize} text-red-600 fill-red-500 drop-shadow-lg ${isDragging ? 'scale-110' : ''}`} />;
              case 'balloon':
                const balloonColor = entity.color || 'text-red-500 fill-red-400';
                const baseColor = balloonColor.split('-')[1];
                return (
                  <div className="relative group">
                     <div className="absolute top-[95%] left-1/2 w-0.5 h-16 bg-white/70 -translate-x-1/2 origin-top animate-bounce-slow"></div>
                     <div className={`w-20 h-24 md:w-24 md:h-28 rounded-[50%] rounded-b-[40%] shadow-inner flex items-center justify-center relative overflow-hidden bg-gradient-to-br from-${baseColor}-400 to-${baseColor}-600 border border-${baseColor}-500`}>
                        <div className="absolute top-3 right-5 w-6 h-4 bg-white/40 blur-sm rounded-full transform rotate-45"></div>
                     </div>
                     <div className={`absolute bottom-[-6px] left-1/2 w-3 h-3 bg-${baseColor}-600 -translate-x-1/2 rounded-sm rotate-45`}></div>
                  </div>
                ); 
              default:
                return <div className={`${standardSize} rounded-full bg-white/50`} />;
            }
          };

          if (clicked && entity.isTarget && theme.id !== 'forest' && !isPopping) {
            return null; 
          }

          const bonusClass = entity.isBonus ? 'drop-shadow-[0_0_15px_rgba(250,204,21,0.8)] scale-110' : '';

          return (
            <div
              ref={elementRef}
              className={`absolute flex items-center justify-center select-none ${animationClass} ${interacted && !entity.isTarget ? 'shake opacity-50' : ''} ${isDragging ? 'cursor-grabbing' : 'cursor-grab'} ${bonusClass}`}
              style={style}
              onAnimationEnd={() => {
                if (isPopping) {
                     onClick(entity.id, entity.isTarget, entity.letter, 0, 0); // Coords ignored here
                } else {
                     onAnimationEnd(entity.id)
                }
              }}
              onClick={theme.id !== 'forest' ? handleClick : undefined}
              onTouchStart={theme.id !== 'forest' ? handleClick : (e) => handleDragStart(e.touches[0].clientX, e.touches[0].clientY)}
              onMouseDown={theme.id === 'forest' ? (e) => handleDragStart(e.clientX, e.clientY) : undefined}
              onTouchMove={theme.id === 'forest' ? (e) => handleDragMove(e.touches[0].clientX, e.touches[0].clientY) : undefined}
              onTouchEnd={theme.id === 'forest' ? handleDragEnd : undefined}
            >
              <div className="relative transform transition-transform active:scale-95 flex items-center justify-center pointer-events-none">
                {renderIcon()}
                <span 
                    className={`absolute inset-0 flex items-center justify-center font-black ${entity.isBonus ? 'text-yellow-200 drop-shadow-[0_2px_2px_rgba(0,0,0,0.8)]' : 'text-white drop-shadow-md'} pb-2
                    ${theme.id === 'sea' ? 'text-5xl md:text-7xl' : 'text-3xl md:text-5xl'}`} 
                    style={{ 
                        fontFamily: '"Baloo Bhaijaan 2", sans-serif',
                        transform: theme.id === 'sea' ? 'scaleX(-1)' : 'none' 
                    }}
                >
                  {entity.letter}
                </span>
              </div>
            </div>
          );
        };

        // --- 5. GAME ENGINE ---
        const GameEngine = ({ theme, level, onGameOver, onExit }) => {
          const WAVE_DURATION = 12; 
          const SPAWN_INTERVAL_MS = 1000;
          const MAX_FOREST_OBJECTS = 14; 
          const IDLE_TIMEOUT_MS = 40000; 
          const MAX_SCREEN_OBJECTS = 15; 

          const RANDOM_COLORS = [
            'text-red-500 fill-red-200',
            'text-orange-500 fill-orange-200',
            'text-yellow-500 fill-yellow-200',
            'text-teal-500 fill-teal-200',
            'text-pink-500 fill-pink-200',
            'text-purple-500 fill-purple-200',
            'text-blue-500 fill-blue-200'
          ];

          const [score, setScore] = useState(0);
          const [lives, setLives] = useState(3);
          const [targetLetterData, setTargetLetterData] = useState(null);
          const [targetDisplayForm, setTargetDisplayForm] = useState(''); 
          const [timeLeft, setTimeLeft] = useState(WAVE_DURATION);
          const [objects, setObjects] = useState([]);
          const [isPaused, setIsPaused] = useState(false);
          const [showAnnouncement, setShowAnnouncement] = useState(false);
          const [particles, setParticles] = useState([]);
          const [wrongMarks, setWrongMarks] = useState([]);
          const [floatingTexts, setFloatingTexts] = useState([]);
          const [showDragHint, setShowDragHint] = useState(false);
          
          const mistakesRef = useRef(new Set());
          const timerRef = useRef(null);
          const spawnerRef = useRef(null);
          const idleTimerRef = useRef(null);
          const waveRef = useRef(1);
          const basketRef = useRef(null);
          const spawnBagRef = useRef([]);

          const calculateStars = (finalScore) => {
              if (finalScore >= 120) return 3;
              if (finalScore >= 50) return 2;
              return 1;
          };

          const triggerGameOver = (finalScore, finalLives) => {
              clearIntervals();
              audioManager.playSFX('gameover');
              onGameOver({
                  score: finalScore,
                  lives: finalLives,
                  wave: waveRef.current,
                  mistakes: Array.from(mistakesRef.current),
                  level,
                  stars: calculateStars(finalScore)
              });
          };

          const resetIdleTimer = () => {
            if (idleTimerRef.current) clearTimeout(idleTimerRef.current);
            idleTimerRef.current = setTimeout(() => {
                triggerGameOver(score, 0);
            }, IDLE_TIMEOUT_MS);
          };

          useEffect(() => {
              if (theme.id === 'forest') {
                  setShowDragHint(true);
                  const t = setTimeout(() => setShowDragHint(false), 4000);
                  return () => clearTimeout(t);
              } else {
                  setShowDragHint(false);
              }
          }, [theme.id]);

          const spawnParticles = (x, y) => {
              const colors = ['#f43f5e', '#fbbf24', '#34d399', '#60a5fa'];
              const newParticles = Array.from({ length: 12 }).map((_, i) => ({
                  id: Date.now() + i,
                  x,
                  y,
                  color: colors[Math.floor(Math.random() * colors.length)]
              }));
              setParticles(prev => [...prev, ...newParticles]);
              setTimeout(() => {
                  setParticles(prev => prev.filter(p => p.id < Date.now()));
              }, 1000);
          };

          const spawnWrongMark = (x, y) => {
              const id = Date.now();
              setWrongMarks(prev => [...prev, { id, x, y }]);
              setFloatingTexts(prev => [...prev, { id, x, y, text: '-5' }]);
              
              setTimeout(() => {
                  setWrongMarks(prev => prev.filter(w => w.id !== id));
                  setFloatingTexts(prev => prev.filter(t => t.id !== id));
              }, 1500);
          };

          useEffect(() => {
            const handleUserActivity = () => {
                if (!isPaused) resetIdleTimer();
            };
            window.addEventListener('mousedown', handleUserActivity);
            window.addEventListener('touchstart', handleUserActivity);
            resetIdleTimer();
            return () => {
                window.removeEventListener('mousedown', handleUserActivity);
                window.removeEventListener('touchstart', handleUserActivity);
                if (idleTimerRef.current) clearTimeout(idleTimerRef.current);
            };
          }, [isPaused, score, lives]);

          useEffect(() => {
              const handleVisibilityChange = () => {
                  if (document.hidden) setIsPaused(true);
              };
              document.addEventListener("visibilitychange", handleVisibilityChange);
              return () => document.removeEventListener("visibilitychange", handleVisibilityChange);
          }, []);

          useEffect(() => {
            startNewWave(true);
            audioManager.playBGM(theme.id);
            return () => {
              audioManager.stopBGM();
              clearIntervals();
            };
          }, []);

          const clearIntervals = () => {
            if (timerRef.current) clearInterval(timerRef.current);
            if (spawnerRef.current) clearInterval(spawnerRef.current);
          };

          const getRandomForm = (letterData) => {
            if (level === 1) return letterData.isolated;
            const forms = [letterData.initial, letterData.medial, letterData.final];
            return forms[Math.floor(Math.random() * forms.length)];
          };

          const getNextSpawnType = () => {
            if (spawnBagRef.current.length === 0) {
              const newBag = [true, true, true, false, false, false, false, false, false, false];
              for (let i = newBag.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newBag[i], newBag[j]] = [newBag[j], newBag[i]];
              }
              spawnBagRef.current = newBag;
            }
            return spawnBagRef.current.pop() || false;
          };

          const createForestObject = (targetData, targetForm, existingObjects) => {
                let startX = 0;
                let startY = 0;
                let validPosition = false;
                let attempts = 0;
                
                while (!validPosition && attempts < 50) {
                     attempts++;
                     const testX = Math.random() * 76 + 12; 
                     const testY = Math.random() * 50 + 15;

                     const inLeftExt = Math.pow((testX - 15) * 1.8, 2) + Math.pow((testY - 55) * 1.2, 2) < 1100;
                     const inLeft = Math.pow((testX - 30) * 1.6, 2) + Math.pow((testY - 45) * 1.2, 2) < 1300; 
                     const inRightExt = Math.pow((testX - 85) * 1.8, 2) + Math.pow((testY - 55) * 1.2, 2) < 1100;
                     const inRight = Math.pow((testX - 70) * 1.6, 2) + Math.pow((testY - 45) * 1.2, 2) < 1300;
                     const inTop = Math.pow((testX - 50) * 1.4, 2) + Math.pow((testY - 30) * 1.2, 2) < 1500;

                     if (!inLeft && !inRight && !inTop && !inLeftExt && !inRightExt) continue;

                     let tooClose = false;
                     for (const obj of existingObjects) {
                         const dx = (obj.startX - testX) * 1.6;
                         const dy = (obj.startY - testY);
                         const dist = Math.sqrt(dx*dx + dy*dy);
                         if (dist < 12) { 
                             tooClose = true;
                             break;
                         }
                     }

                     if (!tooClose) {
                         startX = testX;
                         startY = testY;
                         validPosition = true;
                     }
                }

                if (!validPosition) return null; 

                const id = Date.now().toString() + Math.random().toString();
                const hasTarget = existingObjects.some(o => o.originalLetterId === targetData.id);
                const count = existingObjects.length;
                let isTarget = false;
                
                if (!hasTarget && count === 0) isTarget = true;
                else if (!hasTarget && count >= MAX_FOREST_OBJECTS - 2) isTarget = true;
                else isTarget = getNextSpawnType();
                
                let letterData = targetData;
                let displayStr = targetForm;

                if (!isTarget) {
                  const useTrickyDistractor = level === 2 && Math.random() < 0.5;

                  if (useTrickyDistractor) {
                     letterData = targetData;
                     const allForms = [letterData.isolated, letterData.initial, letterData.medial, letterData.final];
                     const wrongForms = allForms.filter(f => f !== targetForm);
                     if (wrongForms.length > 0) {
                         displayStr = wrongForms[Math.floor(Math.random() * wrongForms.length)];
                     } else {
                         displayStr = getRandomForm(letterData);
                     }
                  } else {
                     do {
                        letterData = ARABIC_LETTERS_DATA[Math.floor(Math.random() * ARABIC_LETTERS_DATA.length)];
                     } while (letterData.id === targetData.id);
                     displayStr = getRandomForm(letterData);
                  }
                } else {
                   displayStr = targetForm; 
                }

                const isBonus = Math.random() < 0.15;

                return {
                  id,
                  letter: displayStr,
                  originalLetterId: letterData.id,
                  isTarget,
                  isBonus: isTarget && isBonus, 
                  startX,
                  startY,
                  duration: 0, 
                  delay: 0,
                };
          };

          const startNewWave = (isFirstWave = false) => {
            spawnBagRef.current = [];
            const mistakeArray = Array.from(mistakesRef.current);
            let newTargetData;
            
            if (mistakeArray.length > 0 && Math.random() < 0.3) {
              const wrongId = mistakeArray[Math.floor(Math.random() * mistakeArray.length)];
              newTargetData = ARABIC_LETTERS_DATA.find(l => l.id === wrongId) || ARABIC_LETTERS_DATA[0];
            } else {
              newTargetData = ARABIC_LETTERS_DATA[Math.floor(Math.random() * ARABIC_LETTERS_DATA.length)];
            }
            
            setTargetLetterData(newTargetData);
            const form = getRandomForm(newTargetData);
            setTargetDisplayForm(form);

            setShowAnnouncement(true);
            setTimeout(() => setShowAnnouncement(false), 2000);

            if (newTargetData.audioUrl) {
                audioManager.playLetterSound(newTargetData.audioUrl);
            }

            setTimeLeft(WAVE_DURATION);
            waveRef.current += 1;

            clearIntervals();
            
            if (theme.id === 'forest') {
                reshuffleForest(newTargetData, form);
            } 

            timerRef.current = setInterval(() => {
              setTimeLeft((prev) => {
                if (prev <= 1) {
                  startNewWave(); 
                  return WAVE_DURATION;
                }
                return prev - 1;
              });
            }, 1000);

            spawnerRef.current = setInterval(() => {
               if (theme.id === 'forest') {
                 fillForestTree(newTargetData, form);
               } else {
                 spawnObject(newTargetData, form);
               }
            }, SPAWN_INTERVAL_MS);
          };

          const reshuffleForest = (tgtData, tgtForm) => {
             const newObjects = [];
             spawnBagRef.current = [];
             for(let i=0; i < MAX_FOREST_OBJECTS; i++) {
                 const newObj = createForestObject(tgtData, tgtForm, newObjects);
                 if (newObj) newObjects.push(newObj);
             }
             setObjects(newObjects);
          };

          const fillForestTree = (currentTarget, currentTargetForm) => {
             setObjects(prev => {
                if (prev.length >= MAX_FOREST_OBJECTS) return prev; 
                const newObj = createForestObject(currentTarget, currentTargetForm, prev);
                return newObj ? [...prev, newObj] : prev;
             });
          };

          const spawnObject = (currentTarget, currentTargetForm) => {
            if (isPaused) return;

            setObjects(prevObjects => {
                if (prevObjects.length >= MAX_SCREEN_OBJECTS) {
                    return prevObjects;
                }

                const id = Date.now().toString() + Math.random().toString();
                const isTarget = getNextSpawnType();
                
                let letterData = currentTarget;
                let displayStr = currentTargetForm;

                if (!isTarget) {
                  const useTrickyDistractor = level === 2 && Math.random() < 0.5;

                  if (useTrickyDistractor) {
                     letterData = currentTarget;
                     const allForms = [letterData.isolated, letterData.initial, letterData.medial, letterData.final];
                     const wrongForms = allForms.filter(f => f !== currentTargetForm);
                     if (wrongForms.length > 0) {
                         displayStr = wrongForms[Math.floor(Math.random() * wrongForms.length)];
                     } else {
                         displayStr = getRandomForm(letterData);
                     }
                  } else {
                     do {
                        letterData = ARABIC_LETTERS_DATA[Math.floor(Math.random() * ARABIC_LETTERS_DATA.length)];
                     } while (letterData.id === currentTarget.id);
                     displayStr = getRandomForm(letterData);
                  }
                } else {
                  displayStr = currentTargetForm;
                }

                let startX = Math.random() * 80 + 10;
                
                let duration = 5;
                if (theme.id === 'sea') {
                  duration = Math.random() * 5 + 9;
                } else {
                  duration = Math.random() * 5 + 8;
                }

                const isBonus = Math.random() < 0.15;

                const newObj = {
                  id,
                  letter: displayStr,
                  originalLetterId: letterData.id,
                  isTarget,
                  isBonus: isTarget && isBonus,
                  startX: startX,
                  duration: duration, 
                  delay: 0,
                  lane: Math.floor(Math.random() * 6) + 1,
                  color: RANDOM_COLORS[Math.floor(Math.random() * RANDOM_COLORS.length)]
                };

                return [...prevObjects, newObj];
            });
          };

          useEffect(() => {
            if (isPaused) {
              clearIntervals();
            } else {
              if (targetLetterData) {
                timerRef.current = setInterval(() => {
                  setTimeLeft((prev) => {
                    if (prev <= 1) {
                      startNewWave();
                      return WAVE_DURATION;
                    }
                    return prev - 1;
                  });
                }, 1000);
                
                spawnerRef.current = setInterval(() => {
                     if (theme.id === 'forest') {
                        fillForestTree(targetLetterData, targetDisplayForm);
                     } else {
                        spawnObject(targetLetterData, targetDisplayForm);
                     }
                }, SPAWN_INTERVAL_MS);
              }
            }
            return () => clearIntervals();
          }, [isPaused, targetLetterData, targetDisplayForm]);

          const handleCorrect = (id, isBonus = false, clickX, clickY) => {
              resetIdleTimer();
              setShowDragHint(false);
              const points = isBonus ? 30 : 10;
              setScore((prev) => prev + points);
              if (isBonus) audioManager.playSFX('win');
              else audioManager.playThemeSFX('correct', theme.id);
              
              if (clickX && clickY) {
                  spawnParticles(clickX, clickY);
              }
              setObjects((prev) => prev.filter(o => o.id !== id));
          };

          const handleWrong = (letterId, clickX, clickY) => {
              resetIdleTimer();
              setShowDragHint(false);
              
              // AUDIO FEEDBACK: Replay correct sound
              if (targetLetterData?.audioUrl) {
                  audioManager.playLetterSound(targetLetterData.audioUrl);
              }

              if (clickX && clickY) spawnWrongMark(clickX, clickY);
              
              setScore(prev => Math.max(0, prev - 5));
              setLives((prev) => {
                const newLives = prev - 1;
                if (newLives <= 0) {
                  triggerGameOver(score, 0);
                } else {
                  audioManager.playThemeSFX('wrong', theme.id);
                }
                return newLives;
              });
              if (targetLetterData) mistakesRef.current.add(targetLetterData.id);
          };

          const handleObjectClick = useCallback((id, _ignoredIsTarget, displayStr, x, y) => {
            if (isPaused || !targetLetterData) return;
            const obj = objects.find(o => o.id === id);
            if (!obj) return;
            
            let isActuallyTarget = false;
            if (level === 2) {
                isActuallyTarget = obj.letter === targetDisplayForm;
            } else {
                isActuallyTarget = obj.originalLetterId === targetLetterData.id;
            }

            if (isActuallyTarget) {
              handleCorrect(id, obj.isBonus, x, y);
            } else {
              handleWrong(displayStr, x, y);
            }
          }, [isPaused, score, lives, theme.id, targetLetterData, objects, level, targetDisplayForm]);

          const handleObjectDrop = useCallback((id, x, y) => {
             if (isPaused || !basketRef.current || !targetLetterData) return;
             const basketRect = basketRef.current.getBoundingClientRect();
             const padding = 30; 
             const isInside = 
                x >= basketRect.left - padding && 
                x <= basketRect.right + padding &&
                y >= basketRect.top - padding && 
                y <= basketRect.bottom + padding;

             if (isInside) {
                const obj = objects.find(o => o.id === id);
                if (obj) {
                    let isActuallyTarget = false;
                    if (level === 2) {
                        isActuallyTarget = obj.letter === targetDisplayForm;
                    } else {
                        isActuallyTarget = obj.originalLetterId === targetLetterData.id;
                    }

                    if (isActuallyTarget) {
                        handleCorrect(id, obj.isBonus, x, y);
                    } else {
                        handleWrong(obj.letter, x, y);
                    }
                }
             }
          }, [isPaused, objects, theme.id, targetLetterData, lives, level, targetDisplayForm]);

          const handleAnimationEnd = useCallback((id) => {
            if (theme.id !== 'forest') {
               setObjects((prev) => prev.filter(obj => obj.id !== id));
            }
          }, [theme.id]);

          return (
            <div className={`relative w-full h-full overflow-hidden ${theme.backgroundClass}`} dir="rtl">
              
              {/* TARGET ANNOUNCEMENT OVERLAY */}
              {showAnnouncement && targetLetterData && (
                <div className="absolute inset-0 z-[100] flex items-center justify-center bg-black/30 backdrop-blur-sm pointer-events-none">
                    <div className="animate-entrance bg-white rounded-[3rem] p-10 md:p-14 border-8 border-yellow-400 shadow-[0_0_60px_rgba(250,204,21,0.6)] flex flex-col items-center transform scale-125">
                        <span className="text-9xl font-black text-indigo-600 mb-4 drop-shadow-md" style={{ fontFamily: 'Baloo Bhaijaan 2' }}>{targetDisplayForm}</span>
                        <span className="text-3xl font-bold text-gray-500">ابحث عن هذا الحرف!</span>
                    </div>
                </div>
              )}
              
              {/* PARTICLES & WRONG MARKS */}
              {particles.map(p => (
                  <div key={p.id} className="particle" style={{ left: p.x, top: p.y, backgroundColor: p.color, '--tx': (Math.random() - 0.5) * 100 + 'px', '--ty': (Math.random() - 0.5) * 100 + 'px' }} />
              ))}
              {wrongMarks.map(w => (
                  <div key={w.id} className="absolute animate-wrong z-[60] pointer-events-none text-red-600 drop-shadow-lg" style={{ left: w.x - 12, top: w.y - 12 }}>
                     <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></svg>
                  </div>
      ))}
      {floatingTexts.map(t => (
          <FloatingText key={t.id} x={t.x} y={t.y} text={t.text} />
      ))}

      {theme.id === 'forest' && (
        <div className="absolute bottom-0 left-0 w-full h-[85vh] z-0 pointer-events-none">
          <div className="absolute bottom-0 left-1/2 transform -translate-x-1/2 w-[18vh] h-[40%] bg-gradient-to-r from-[#3e2723] to-[#5d4037] z-0 rounded-t-lg shadow-2xl" />
          
          <div className="absolute bottom-[25%] left-1/2 transform -translate-x-1/2 w-[98vw] md:w-[95vw] h-[65%] z-10">
             <svg viewBox="0 0 1400 600" className="w-full h-full drop-shadow-2xl">
                <g fill="#1b5e20">
                   <circle cx="150" cy="400" r="180" />
                   <circle cx="350" cy="350" r="200" />
                   <circle cx="1250" cy="400" r="180" />
                   <circle cx="1050" cy="350" r="200" />
                   <circle cx="700" cy="300" r="250" />
                </g>
                <g fill="#2e7d32">
                   <circle cx="250" cy="300" r="160" />
                   <circle cx="1150" cy="300" r="160" />
                   <circle cx="500" cy="220" r="180" />
                   <circle cx="900" cy="220" r="180" />
                </g>
                <g fill="#43a047">
                   <circle cx="350" cy="250" r="150" />
                   <circle cx="1050" cy="250" r="150" />
                   <circle cx="700" cy="120" r="180" />
                   <circle cx="700" cy="300" r="180" />
                </g>
             </svg>
          </div>
          
          <div 
             ref={basketRef}
             className="absolute bottom-4 left-1/2 transform -translate-x-1/2 z-20 flex flex-col items-center transition-transform hover:scale-105 pointer-events-auto"
          >
             <CustomBasketIcon size={120} className="drop-shadow-2xl" />
             <div className="bg-white/80 px-4 py-1 rounded-full text-base font-bold text-amber-900 mt-[-10px] shadow-sm backdrop-blur-sm border border-amber-900/20">اسحب هنا</div>
             
             {/* DRAG HINT ANIMATION */}
             {showDragHint && (
                 <div className="absolute top-[-50px] left-1/2 -translate-x-1/2 animate-bounce">
                     <Hand size={40} className="text-white fill-white drop-shadow-lg" />
                 </div>
             )}
          </div>
        </div>
      )}

      {theme.id === 'sea' && (
        <div className="absolute inset-0 bg-blue-500/10 z-0 pointer-events-none" />
      )}

      {/* HUD */}
      <div className="absolute top-0 left-0 w-full p-4 z-50 flex flex-col gap-2 pointer-events-none">
        <div className="flex justify-between items-start pointer-events-auto">
          <div className="flex gap-2">
             <button 
              onClick={() => { audioManager.playUISFX('click'); onExit(); }}
              className="bg-red-500 hover:bg-red-600 text-white p-2 rounded-full shadow-lg transition-transform hover:scale-105"
            >
              <LogOut size={24} />
            </button>
            <button 
              onClick={() => { audioManager.playUISFX('click'); setIsPaused(!isPaused); }}
              className="bg-white/90 text-blue-800 p-2 rounded-full shadow-lg transition-transform hover:scale-105"
            >
              {isPaused ? <Play size={24} /> : <Pause size={24} />}
            </button>
            <div className="bg-white/90 px-4 py-2 rounded-full shadow-lg font-bold text-blue-900 text-xl min-w-[100px] text-center" style={{fontFamily: 'Baloo Bhaijaan 2'}}>
              {score}
            </div>
          </div>

          <div className="absolute left-1/2 transform -translate-x-1/2 top-4">
             <div className="bg-yellow-400 border-4 border-white shadow-2xl rounded-2xl w-24 h-24 flex items-center justify-center animate-bounce-slow">
                <span className="text-5xl font-black text-blue-900 pb-2" style={{ fontFamily: 'Baloo Bhaijaan 2' }}>
                  {targetDisplayForm}
                </span>
             </div>
             <div className="text-center mt-1 bg-black/30 rounded-full px-2 text-white font-bold text-sm">
                الهدف
             </div>
          </div>

          <div className="flex flex-col items-end gap-2">
            <div className="flex gap-1">
              {[...Array(3)].map((_, i) => (
                <Heart 
                  key={i} 
                  className={`w-8 h-8 ${i < lives ? 'text-red-500 fill-red-500' : 'text-gray-400 fill-gray-400'}`} 
                />
              ))}
            </div>
            <div className={`bg-white/90 w-16 h-16 rounded-full flex items-center justify-center border-4 shadow-lg transition-colors ${timeLeft < 5 ? 'border-red-500 text-red-600 animate-pulse' : 'border-blue-300 text-gray-700'}`}>
               <span className="font-bold text-2xl">{timeLeft}</span>
            </div>
          </div>
        </div>
      </div>

      {isPaused && (
        <div className="absolute inset-0 z-40 bg-black/40 backdrop-blur-sm flex items-center justify-center">
          <div className="text-white text-4xl font-bold bg-blue-600 px-8 py-4 rounded-xl shadow-2xl">
            توقف مؤقت
          </div>
        </div>
      )}

      <div className={`relative w-full h-full z-10 ${theme.id === 'sea' ? 'cursor-crosshair' : ''}`}>
        {objects.map((obj) => (
          <GameObject 
            key={obj.id} 
            entity={obj} 
            theme={theme} 
            onClick={handleObjectClick}
            onDrop={handleObjectDrop}
            onAnimationEnd={handleAnimationEnd}
          />
        ))}
      </div>
    </div>
  );
};

        // --- 6. APP ---
        const THEMES = [
          { id: 'sea', name: 'البحر', backgroundClass: 'bg-gradient-to-b from-cyan-300 to-blue-600', objectIcon: 'fish', primaryColor: 'blue' },
          { id: 'forest', name: 'الغابة', backgroundClass: 'bg-gradient-to-b from-sky-300 to-green-600', objectIcon: 'apple', primaryColor: 'green' },
          { id: 'sky', name: 'السماء', backgroundClass: 'bg-gradient-to-b from-blue-300 to-white', objectIcon: 'balloon', primaryColor: 'sky' },
        ];

        function App() {
          const [gameState, setGameState] = useState('menu');
          const [selectedThemeId, setSelectedThemeId] = useState(null); 
          const [selectedLevel, setSelectedLevel] = useState(1);
          const [isMuted, setIsMuted] = useState(false);
          const [lastStats, setLastStats] = useState(null);

          // Hide loading screen on mount
          useEffect(() => {
             const loader = document.getElementById('loading-screen');
             if(loader) {
                 loader.style.opacity = '0';
                 setTimeout(() => loader.remove(), 500);
             }
          }, []);

          const toggleMute = () => {
            audioManager.playUISFX('click');
            const newState = !isMuted;
            setIsMuted(newState);
            audioManager.setMute(newState);
          };

          const playHover = () => audioManager.playUISFX('hover');
          const playClick = () => audioManager.playUISFX('click');

          const handleThemeSelect = (id) => {
            playClick();
            setSelectedThemeId(id);
          };

          const handleStartGame = () => {
            if (!selectedThemeId) return;
            playClick();
            setGameState('playing');
          };

          const getActiveTheme = () => {
             if (selectedThemeId === 'random') {
                const available = THEMES;
                return available[Math.floor(Math.random() * available.length)];
             }
             return THEMES.find(t => t.id === selectedThemeId) || THEMES[0];
          };

          const handleGameOver = (stats) => {
            setLastStats(stats);
            setGameState('gameover');
          };

          const exitGame = () => {
            playClick();
            audioManager.stopBGM();
            setGameState('menu');
            setSelectedThemeId(null);
          };

          /* --- MENU --- */
          if (gameState === 'menu') {
            return (
              <div className="fixed inset-0 w-full h-[100dvh] bg-slate-50 overflow-hidden" dir="rtl">
                <div className="w-full h-full overflow-y-auto flex flex-col items-center py-6 px-4 pb-40">
                    
                    <div className="fixed top-0 left-0 w-full h-full overflow-hidden pointer-events-none z-0">
                    <div className="absolute top-[-10%] left-[-10%] w-[50vw] h-[50vw] bg-purple-200 rounded-full blur-[100px] opacity-40"></div>
                    <div className="absolute bottom-[-10%] right-[-10%] w-[50vw] h-[50vw] bg-yellow-200 rounded-full blur-[100px] opacity-40"></div>
                    </div>

                    <div className="relative z-10 bg-white/80 backdrop-blur-2xl rounded-[3rem] p-6 md:p-8 shadow-2xl w-full max-w-4xl text-center border border-white/50 mt-4 mb-4 shrink-0">
                    
                    <div className="mb-4">
                        <h1 className="text-5xl md:text-7xl font-black text-transparent bg-clip-text bg-gradient-to-r from-indigo-600 to-purple-600 drop-shadow-sm mb-2" style={{ fontFamily: 'Baloo Bhaijaan 2' }}>
                        مغامرة الحروف
                        </h1>
                        <p className="text-gray-500 text-lg md:text-xl font-bold tracking-wide">تعلم الحروف العربية بطريقة ممتعة وتفاعلية</p>
                    </div>

                    <button 
                        onClick={toggleMute}
                        onMouseEnter={playHover}
                        className="absolute top-6 left-6 md:top-8 md:left-8 p-3 bg-white text-gray-500 rounded-full hover:bg-gray-100 shadow-md transition-all hover:scale-110"
                    >
                        {isMuted ? <VolumeX size={24} /> : <Volume2 size={24} />}
                    </button>

                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-8 mb-6">
                        <div className="bg-white/50 rounded-3xl p-4 md:p-6 border border-indigo-50 shadow-sm">
                            <div className="flex items-center gap-2 mb-2 md:mb-4 justify-center text-indigo-800">
                            <Star className="fill-yellow-400 text-yellow-500" />
                            <h3 className="text-xl md:text-2xl font-bold">المستوى</h3>
                            </div>
                            
                            <div className="grid grid-cols-2 gap-3 md:gap-4 h-full">
                            <button 
                                onClick={() => { playClick(); setSelectedLevel(1); }}
                                onMouseEnter={playHover}
                                className={`p-3 md:p-4 rounded-2xl border-2 transition-all duration-300 flex flex-col items-center justify-center gap-1 md:gap-2 ${selectedLevel === 1 ? 'bg-indigo-600 border-indigo-600 text-white shadow-lg shadow-indigo-200 scale-105' : 'bg-white border-gray-100 text-gray-400 hover:bg-indigo-50 hover:border-indigo-200'}`}
                            >
                                <span className="text-4xl md:text-5xl font-black">أ</span>
                                <span className="font-bold text-xs md:text-sm">الحروف المنفصلة</span>
                            </button>

                            <button 
                                onClick={() => { playClick(); setSelectedLevel(2); }}
                                onMouseEnter={playHover}
                                className={`p-3 md:p-4 rounded-2xl border-2 transition-all duration-300 flex flex-col items-center justify-center gap-1 md:gap-2 ${selectedLevel === 2 ? 'bg-purple-600 border-purple-600 text-white shadow-lg shadow-purple-200 scale-105' : 'bg-white border-gray-100 text-gray-400 hover:bg-purple-50 hover:border-purple-200'}`}
                            >
                                <span className="text-4xl md:text-5xl font-black">ـبـ</span>
                                <span className="font-bold text-xs md:text-sm">أشكال الحروف</span>
                            </button>
                            </div>
                        </div>

                        <div className="bg-white/50 rounded-3xl p-4 md:p-6 border border-indigo-50 shadow-sm">
                            <div className="flex items-center gap-2 mb-2 md:mb-4 justify-center text-indigo-800">
                            <LayoutGrid className="text-indigo-600" />
                            <h3 className="text-xl md:text-2xl font-bold">العالم</h3>
                            </div>

                            <div className="grid grid-cols-2 gap-2 md:gap-3">
                            {THEMES.map(t => {
                                const Icon = t.id === 'sea' ? Fish : t.id === 'forest' ? Apple : Cloud;
                                const isSelected = selectedThemeId === t.id;
                                
                                let activeClass = '';
                                if (t.id === 'sea') activeClass = 'bg-gradient-to-br from-cyan-400 to-blue-600 border-blue-600 shadow-cyan-200';
                                if (t.id === 'forest') activeClass = 'bg-gradient-to-br from-emerald-400 to-green-600 border-green-600 shadow-green-200';
                                if (t.id === 'sky') activeClass = 'bg-gradient-to-br from-sky-400 to-indigo-500 border-indigo-600 shadow-sky-200';

                                return (
                                <button
                                    key={t.id}
                                    onClick={() => handleThemeSelect(t.id)}
                                    onMouseEnter={playHover}
                                    className={`relative p-2 md:p-3 rounded-2xl border-2 transition-all group overflow-hidden flex flex-col items-center justify-center min-h-[85px] md:min-h-[110px]
                                    ${isSelected 
                                        ? `${activeClass} text-white scale-105 shadow-xl` 
                                        : 'bg-white border-gray-100 text-gray-400 hover:bg-gray-50 hover:border-gray-200'}
                                    `}
                                >
                                    <div className="mb-1">
                                      <Icon className={`w-8 h-8 md:w-9 md:h-9 drop-shadow-sm ${isSelected ? 'text-white' : 'text-gray-300 group-hover:text-gray-500 transition-colors'}`} />
                                    </div>
                                    <span className="block font-bold text-sm md:text-lg">
                                      {t.name}
                                    </span>
                                </button>
                                );
                            })}
                            <button
                                onClick={() => handleThemeSelect('random')}
                                onMouseEnter={playHover}
                                className={`relative p-2 md:p-3 rounded-2xl border-2 transition-all flex flex-col items-center justify-center min-h-[85px] md:min-h-[110px]
                                    ${selectedThemeId === 'random' 
                                        ? 'bg-gradient-to-br from-orange-400 to-red-500 border-orange-600 text-white scale-105 shadow-xl shadow-orange-200' 
                                        : 'bg-white border-gray-100 text-gray-400 hover:bg-gray-50 hover:border-gray-200'}
                                `}
                                >
                                <div className={`w-8 h-8 md:w-10 md:h-10 mb-1 flex items-center justify-center text-2xl md:text-3xl font-black ${selectedThemeId === 'random' ? 'text-white' : 'text-gray-300'}`}>?</div>
                                <span className="block font-bold text-sm md:text-lg">عشوائي</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div className="fixed bottom-0 left-0 w-full p-4 bg-white/90 backdrop-blur-md border-t border-gray-200 shadow-[0_-10px_30px_rgba(0,0,0,0.1)] z-50 md:static md:bg-transparent md:border-none md:shadow-none md:p-0">
                        <button
                            onClick={handleStartGame}
                            disabled={!selectedThemeId}
                            onMouseEnter={playHover}
                            className={`w-full py-4 md:py-5 rounded-2xl font-black text-2xl md:text-3xl shadow-xl transition-all transform flex items-center justify-center gap-3 relative overflow-hidden group
                                ${selectedThemeId 
                                    ? 'bg-gradient-to-r from-green-500 to-emerald-600 text-white hover:scale-[1.02] active:scale-[0.98] shadow-green-200 cursor-pointer' 
                                    : 'bg-gray-100 text-gray-300 cursor-not-allowed'
                                }
                            `}
                        >
                            <div className="absolute inset-0 bg-white/20 translate-y-full group-hover:translate-y-0 transition-transform duration-300 rounded-2xl"></div>
                            <Play className="w-8 h-8 md:w-9 md:h-9 relative z-10" fill="currentColor" />
                            <span className="relative z-10">{selectedThemeId ? 'ابدأ المغامرة' : 'اختر عالماً للبدء'}</span>
                        </button>
                    </div>

                    </div>
                </div>
              </div>
            );
          }

          /* --- GAME OVER --- */
          if (gameState === 'gameover' && lastStats) {
            const stars = lastStats.stars || 1; // Default to 1 if missing for some reason

            return (
              <div className="fixed inset-0 w-full h-[100dvh] bg-slate-900 overflow-hidden" dir="rtl">
                 <div className="w-full h-full overflow-y-auto flex flex-col items-center justify-center p-4">
                    <div className="bg-white rounded-[2.5rem] p-8 shadow-2xl w-full max-w-md text-center animate-bounce-slow relative overflow-hidden border-8 border-white/10 ring-4 ring-white/50 my-auto shrink-0">
                        <div className={`absolute top-0 left-0 w-full h-4 ${lastStats.score > 50 ? 'bg-green-500' : 'bg-red-500'}`}></div>
                        
                        <div className="mb-4 flex justify-center mt-2">
                           {/* STAR RATING DISPLAY */}
                           <div className="flex gap-2">
                               {[1, 2, 3].map(s => (
                                   <Star 
                                     key={s} 
                                     size={48} 
                                     className={`transform transition-all duration-500 ${s <= stars ? 'text-yellow-400 fill-yellow-400 scale-110 drop-shadow-lg' : 'text-gray-200 fill-gray-100'}`} 
                                   />
                               ))}
                           </div>
                        </div>

                        <h2 className="text-5xl font-black text-gray-800 mb-2">
                        {stars === 3 ? 'ممتاز!' : stars === 2 ? 'عمل رائع!' : 'حاول مرة أخرى'}
                        </h2>
                        
                        <div className="flex flex-col gap-4 mb-8 mt-6">
                        <div className="bg-slate-50 p-4 rounded-2xl border border-slate-200 flex flex-col items-center shadow-inner">
                            <span className="text-slate-400 text-sm font-bold tracking-wider mb-1">النتيجة النهائية</span>
                            <div className="text-7xl font-black text-slate-700 drop-shadow-sm">{lastStats.score}</div>
                        </div>

                        {lastStats.mistakes.length > 0 && (
                            <div className="bg-red-50 p-4 rounded-2xl border border-red-100">
                                <span className="text-red-400 text-sm font-bold tracking-wider">حروف تحتاج لمراجعة</span>
                                <div className="flex flex-wrap gap-2 justify-center mt-3">
                                {lastStats.mistakes.slice(0, 5).map((m, i) => (
                                    <span key={i} className="w-12 h-12 flex items-center justify-center bg-white rounded-xl shadow-sm border border-red-100 text-red-600 font-black text-2xl">{m}</span>
                                ))}
                                {lastStats.mistakes.length > 5 && <span className="text-gray-400 text-xs self-center">...</span>}
                                </div>
                            </div>
                        )}
                        </div>

                        <div className="flex gap-4 justify-center">
                        <button 
                            onClick={exitGame}
                            onMouseEnter={playHover}
                            className="flex-1 py-4 bg-gray-100 text-gray-600 rounded-xl font-bold hover:bg-gray-200 transition-colors flex items-center justify-center gap-2"
                        >
                            <LogOut size={22} /> القائمة
                        </button>
                        <button 
                            onClick={() => setGameState('playing')}
                            onMouseEnter={playHover}
                            className="flex-1 py-4 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 transition-colors shadow-lg shadow-indigo-200 flex items-center justify-center gap-2"
                        >
                            <RotateCcw size={22} /> العب مجدداً
                        </button>
                        </div>
                    </div>
                 </div>
              </div>
            );
          }

          const activeTheme = getActiveTheme();

          return (
            <div className="fixed inset-0 w-full h-[100dvh] overflow-hidden">
              <GameEngine 
                theme={activeTheme} 
                level={selectedLevel}
                onGameOver={handleGameOver} 
                onExit={exitGame}
              />
            </div>
          );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
